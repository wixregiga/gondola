// Package genutil contains helper functions for autogenerating code.
package genutil

import (
	"bytes"
	"fmt"
	"go/format"
	"gondola/util/fileutil"
	"io/ioutil"
	"os"
	"strings"
)

// AutogenString returns the string which makes
// gondola identify this file as autogenerated.
func AutogenString() string {
	return fmt.Sprintf("\n// AUTOMATICALLY GENERATED WITH %s -- DO NOT EDIT!\n\n", strings.Join(os.Args, " "))
}

// IsAutogen returns wheter the given filename exists and
// was autogenerated by a gondola tool.
func IsAutogen(filename string) bool {
	b, _ := ioutil.ReadFile(filename)
	if b != nil {
		return bytes.Index(b, []byte("// AUTOMATICALLY GENERATED WITH")) >= 0
	}
	return false
}

// WriteAutogen writes the given autogenerated data to the given filename.
// Code will be first formatted using go/format.
// It will only overwrite the existing file if it was autogenerated.
// Tools autogenerating code should always use this function to avoid
// overwriting files which are not autogenerated.
func WriteAutogen(filename string, data []byte) error {
	formatted, err := format.Source(data)
	if err != nil {
		return err
	}
	overwrite := IsAutogen(filename)
	return fileutil.WriteFile(filename, formatted, overwrite, 0644)
}
